{% set active_page = request.endpoint %}
<!DOCTYPE html>
<html>
<head>
  <title>Floriva</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  {% set active_page = request.endpoint %}

  <div class="image-container">
    <img class="background" src="{{ url_for('static', filename='download.jpeg') }}" alt="Background">

    <div class="menu">
      <img class="logo" src="{{ url_for('static', filename='Logo.png') }}" alt="Logo">
      <h1 class="header">Floriva</h1>

      <p class="home">
        <a href="{{ url_for('index') }}" class="{% if active_page == 'index' %}active{% endif %}">Home</a>
      </p>
      <p class="about">
        <a href="{{ url_for('about') }}" class="{% if active_page == 'about' %}active{% endif %}">About</a>
      </p>
      <p class="contact">
        <a href="{{ url_for('contact') }}" class="{% if active_page == 'contact' %}active{% endif %}">Contact</a>
      </p>
    </div>
  </div>

  <div class="box">
    <h1 class="header1">Manage your greenhouse smarter</h1>
    <p class="track">Track your greenhouse easily ðŸ’¹</p> 
    <button class="button">Create account</button>
    <button class="button1">Login</button>
  </div>

  <!-- Step 1: Create Account -->
  <div id="createAccountModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>Create an account</h2>

      <form class="account-form" id="accountForm" action="/register" method="POST">
        <!-- Name + Surname -->
        <div class="input-row">
          <div class="input-group">
            <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
              <path d="M320 312C386.3 312 440 258.3 440 192C440 125.7 386.3 72 320 72C253.7 72 200 125.7 200 192C200 258.3 253.7 312 320 312zM290.3 368C191.8 368 112 447.8 112 546.3C112 562.7 125.3 576 141.7 576L498.3 576C514.7 576 528 562.7 528 546.3C528 447.8 448.2 368 349.7 368L290.3 368z"/>
            </svg>
            <input type="text" name="name" placeholder="Your first name" required>
          </div>

          <div class="input-group">
            <input type="text" name="surname" placeholder="Your surname" required>
          </div>
        </div>

        <!-- Email -->
        <div class="input-group">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
            <path d="M112 128C85.5 128 64 149.5 64 176C64 191.1 71.1 205.3 83.2 214.4L291.2 370.4C308.3 383.2 331.7 383.2 348.8 370.4L556.8 214.4C568.9 205.3 576 191.1 576 176C576 149.5 554.5 128 528 128L112 128zM64 260L64 448C64 483.3 92.7 512 128 512L512 512C547.3 512 576 483.3 576 448L576 260L377.6 408.8C343.5 434.4 296.5 434.4 262.4 408.8L64 260z"/>
          </svg>
          <input type="email" name="email" placeholder="Email" required>
        </div>

        <!-- Phone -->
        <div class="input-group">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
            <path d="M160 96C124.7 96 96 124.7 96 160L96 480C96 515.3 124.7 544 160 544L480 544C515.3 544 544 515.3 544 480L544 160C544 124.7 515.3 96 480 96L160 96zM248 192.7C257.8 190 268.1 195.1 272 204.5L292.3 253.2C295.7 261.5 293.4 271 286.4 276.7L264.3 294.7C280.5 330.5 308.8 359.7 343.9 377.1L363.2 353.5C368.9 346.6 378.4 344.2 386.7 347.6L435.4 367.9C444.8 371.8 449.8 382.1 447.2 391.9L446.4 394.7C437.6 427 406.3 454.6 368.2 446.5C280.7 428 211.9 359.1 193.3 271.6C185.2 233.5 212.8 202.2 245.1 193.4L247.9 192.6z"/>
                </svg>
      <input 
        type="tel" 
        name="telephone" 
        placeholder="06 number" 
        required 
        inputmode="numeric" 
        pattern="[0-9]*" 
        oninput="this.value = this.value.replace(/[^0-9]/g, '');">
              </div>

        <!-- Greenhouse -->
        <div class="input-group">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
            <path d="M320 0L0 320H96V640H544V320H640L320 0zM384 512H256V384H384V512z"/>
          </svg>
          <input type="text" name="greenhouse_name" placeholder="Greenhouse name" required>
        </div>

        <button type="button" id="nextToUsername" class="next-btn">Next</button>
      </form>
    </div>
  </div>

  <!-- Step 2: Username + Password -->
  <div id="usernameModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>Choose Your username</h2>

<form class="account-form" id="usernameForm" action="/register" method="POST">
  <input type="hidden" name="name" id="hiddenName">
  <input type="hidden" name="surname" id="hiddenSurname">
  <input type="hidden" name="email" id="hiddenEmail">
  <input type="hidden" name="telephone" id="hiddenTelephone">
  <input type="hidden" name="greenhouse_name" id="hiddenGreenhouse">

  <!-- Username -->
  <div class="input-group">
    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
      <path d="M463 448.2C440.9 409.8 399.4 384 352 384L288 384C240.6 384 199.1 409.8 177 448.2C212.2 487.4 263.2 512 320 512C376.8 512 427.8 487.3 463 448.2zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 336C359.8 336 392 303.8 392 264C392 224.2 359.8 192 320 192C280.2 192 248 224.2 248 264C248 303.8 280.2 336 320 336z"/>
    </svg>
    <input type="text" name="username" placeholder="Username" required>
  </div>
  <p id="usernameError" style="color:red; display:none;">This username is already taken</p>

  <!-- Password -->
  <div class="input-group">
    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
      <path d="M256 160L256 224L384 224L384 160C384 124.7 355.3 96 320 96C284.7 96 256 124.7 256 160zM192 224L192 160C192 89.3 249.3 32 320 32C390.7 32 448 89.3 448 160L448 224C483.3 224 512 252.7 512 288L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 288C128 252.7 156.7 224 192 224z"/>
    </svg>
    <input type="password" name="password" placeholder="Choose password" required>
  </div>


  <!-- Confirm password -->
  <div class="input-group">
    <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
      <path d="M256 160C256 124.7 284.7 96 320 96C351.7 96 378 119 383.1 149.3C386 166.7 402.5 178.5 420 175.6C437.5 172.7 449.2 156.2 446.3 138.7C436.1 78.1 383.5 32 320 32C249.3 32 192 89.3 192 160L192 224C156.7 224 128 252.7 128 288L128 512C128 547.3 156.7 576 192 576L448 576C483.3 576 512 547.3 512 512L512 288C512 252.7 483.3 224 448 224L256 224L256 160z"/>
    </svg>
    <input type="password" placeholder="Confirm password" required>
  </div>
  <p id="passwordMatch" style="color:red; display:none;">Passwords don't match</p>

  <p id="passwordError" style="color:red; display:none;">Password is too weak. Please meet all requirements.</p>
  <p style="margin-bottom:5px; font-weight:bold;">Password should contain:</p>
  <ul id="passwordRequirements">
    <li id="length" class="invalid">At least 8 characters</li>
    <li id="uppercase" class="invalid">At least 1 uppercase letter</li>
    <li id="lowercase" class="invalid">At least 1 lowercase letter</li>
    <li id="number" class="invalid">At least 1 number</li>
  </ul>

  <div class="password-strength">
    <div id="strengthBar"></div>
    <p id="strengthText"></p>
  </div>
  <button type="submit" class="next-btn" id="toSensor">Save</button>
</form>

    </div>
  </div>

  <!-- Step 3: Sensor Info -->
<div id="sensorModal" class="modal">
  <div class="modal-content">
    <span class="close-btn">&times;</span>
    <h2>What's your Sensor?</h2>

    <form class="account-form" id="sensorForm" action="/add_device" method="POST">
      <div class="input-group">
        <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
          <path d="M480 96H160C124.7 96 96 124.7 96 160v320c0 35.3 28.7 64 64 64h320c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64zm-160 96a96 96 0 1 1 0 192a96 96 0 1 1 0-192z"/>
        </svg>
        <input type="text" name="device_name" placeholder="Device name" required>
      </div>

      <button type="submit" class="next-btn">Save</button>
    </form>
  </div>
</div>

  <!-- Login popup -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close-btn">&times;</span>
      <h2>Login</h2>
<form class="account-form" id="loginForm" action="/login" method="POST">      
    <div class="input-group">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
            <path d="M463 448.2C440.9 409.8 399.4 384 352 384L288 384C240.6 384 199.1 409.8 177 448.2C212.2 487.4 263.2 512 320 512C376.8 512 427.8 487.3 463 448.2zM64 320C64 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320C576 461.4 461.4 576 320 576C178.6 576 64 461.4 64 320zM320 336C359.8 336 392 303.8 392 264C392 224.2 359.8 192 320 192C280.2 192 248 224.2 248 264C248 303.8 280.2 336 320 336z"/>
          </svg>
    <input type="text" name="username" placeholder="Username" required>
        </div>
        <div class="input-group">
          <svg class="icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640">
            <path d="M256 160L256 224L384 224L384 160C384 124.7 355.3 96 320 96C284.7 96 256 124.7 256 160zM192 224L192 160C192 89.3 249.3 32 320 32C390.7 32 448 89.3 448 160L448 224C483.3 224 512 252.7 512 288L512 512C512 547.3 483.3 576 448 576L192 576C156.7 576 128 547.3 128 512L128 288C128 252.7 156.7 224 192 224z"/>
          </svg>
    <input type="password" name="password" placeholder="Password" required>
        </div>
  <button type="submit" class="next-btn">Login</button>
      </form>
      <p id="loginError" style="color:#f55; display:none; margin-top:8px;"></p>

    </div>
  </div>

  {% block content %}{% endblock %}

  <script>
const createModal = document.getElementById("createAccountModal");
const usernameModal = document.getElementById("usernameModal");
const openBtn = document.querySelector(".button");
const closeBtns = document.querySelectorAll(".close-btn");
const nextToUsername = document.getElementById("nextToUsername");
const loginModal = document.getElementById("loginModal");
const loginBtn = document.querySelector(".button1");
const usernameForm = document.getElementById("usernameForm");
const sensorModal = document.getElementById("sensorModal");

// --- Step 1: Open & transition between modals ---
openBtn.addEventListener("click", () => createModal.style.display = "block");

nextToUsername.addEventListener("click", () => {
  const form = document.getElementById("accountForm");

  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  // Pass values to hidden fields
  document.getElementById("hiddenName").value = form.name.value;
  document.getElementById("hiddenSurname").value = form.surname.value;
  document.getElementById("hiddenEmail").value = form.email.value;
  document.getElementById("hiddenTelephone").value = form.telephone.value;
  document.getElementById("hiddenGreenhouse").value = form.greenhouse_name.value;

  createModal.style.display = "none";
  usernameModal.style.display = "block";
});

closeBtns.forEach(btn => btn.addEventListener("click", () => btn.closest(".modal").style.display = "none"));
window.addEventListener("click", e => { if (e.target.classList.contains("modal")) e.target.style.display = "none"; });
loginBtn.addEventListener("click", () => loginModal.style.display = "block");

// --- Login logic ---
const loginForm = document.getElementById("loginForm");
const loginError = document.getElementById("loginError");

loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  const formData = new FormData(loginForm);
  const res = await fetch("/login", {
    method: "POST",
    body: formData
  });

  const data = await res.json();

  const usernameInput = loginForm.querySelector('input[name="username"]');
  const passwordInput = loginForm.querySelector('input[name="password"]');

  // Reset previous styles
  usernameInput.style.border = "";
  passwordInput.style.border = "";
  loginError.style.display = "none";

  if (data.ok) {
    window.location.href = data.redirect;
  } else {
    loginError.textContent = data.error;
    loginError.style.display = "block";

    // ðŸ”¹ Highlight the wrong field(s)
    if (data.error.includes("Username") && data.error.includes("password")) {
      usernameInput.style.border = "2px solid red";
      passwordInput.style.border = "2px solid red";
    } else if (data.error.includes("Username")) {
      usernameInput.style.border = "2px solid red";
    } else if (data.error.includes("password")) {
      passwordInput.style.border = "2px solid red";
    }
  }
});


// --- Step 2: Username + Password validation ---
const usernameInput = document.querySelector('input[name="username"]');
const usernameError = document.getElementById("usernameError");

const passwordInput = document.querySelector('input[name="password"]');
const confirmPassword = document.querySelector('input[placeholder="Confirm password"]');
const passwordError = document.getElementById("passwordError");

const strengthBar = document.getElementById("strengthBar");
const strengthText = document.getElementById("strengthText");
const passwordMatch = document.getElementById("passwordMatch");

const reqLength = document.getElementById("length");
const reqUpper = document.getElementById("uppercase");
const reqLower = document.getElementById("lowercase");
const reqNumber = document.getElementById("number");

let usernameTaken = false;

// âœ… Check username availability (live)
usernameInput.addEventListener("input", async () => {
  const value = usernameInput.value.trim();
  if (!value) {
    usernameError.style.display = "none";
    usernameTaken = false;
    usernameInput.style.border = "";
    return;
  }

  try {
    const res = await fetch(`/check_username?username=${encodeURIComponent(value)}`);
    const text = await res.text();

    if (text === "taken") {
      usernameError.textContent = "This username is already taken";
      usernameError.style.display = "block";
      usernameInput.style.border = "2px solid red";
      usernameTaken = true;
    } else {
      usernameError.style.display = "none";
      usernameInput.style.border = "2px solid green";
      usernameTaken = false;
    }
  } catch (err) {
    console.error("Username check failed:", err);
  }
});

// âœ… Password strength validation
function validatePassword(password) {
  let validCount = 0;
  if (password.length >= 8) { reqLength.className = "valid"; validCount++; } else reqLength.className = "invalid";
  if (/[A-Z]/.test(password)) { reqUpper.className = "valid"; validCount++; } else reqUpper.className = "invalid";
  if (/[a-z]/.test(password)) { reqLower.className = "valid"; validCount++; } else reqLower.className = "invalid";
  if (/[0-9]/.test(password)) { reqNumber.className = "valid"; validCount++; } else reqNumber.className = "invalid";

  if (validCount <= 2) {
    strengthBar.style.width = "33%";
    strengthBar.style.backgroundColor = "red";
    strengthText.textContent = "Weak";
    strengthText.style.color = "red";
  } else if (validCount === 3) {
    strengthBar.style.width = "66%";
    strengthBar.style.backgroundColor = "orange";
    strengthText.textContent = "Medium";
    strengthText.style.color = "orange";
  } else {
    strengthBar.style.width = "100%";
    strengthBar.style.backgroundColor = "green";
    strengthText.textContent = "Strong";
    strengthText.style.color = "green";
  }

  return validCount === 4;
}

passwordInput.addEventListener("input", () => {
  const isValid = validatePassword(passwordInput.value);

  // âœ… Hide error if password is strong
  if (isValid) {
    passwordError.style.display = "none";
  }
});
confirmPassword.addEventListener("input", () => {
  passwordMatch.style.display = confirmPassword.value !== passwordInput.value ? "block" : "none";

  // âœ… Also hide weak password error if user improves password
  if (validatePassword(passwordInput.value)) {
    passwordError.style.display = "none";
  }
});


// âœ… Final form validation + submit
usernameForm.addEventListener("submit", async (e) => {
  e.preventDefault();

  usernameError.style.display = "none";
  passwordError.style.display = "none";
  passwordMatch.style.display = "none";

  // Stop if username already exists
  if (usernameTaken) {
    usernameError.style.display = "block";
    usernameInput.focus();
    return;
  }

  // Stop if password too weak
  const isValid = validatePassword(passwordInput.value);
  if (!isValid) {
    passwordError.style.display = "block";
    passwordInput.focus();
    return;
  }

  // Stop if passwords donâ€™t match
  if (confirmPassword.value !== passwordInput.value) {
    passwordMatch.style.display = "block";
    confirmPassword.focus();
    return;
  }

  // âœ… All good â€” register and move to next step
  const formData = new FormData(e.target);
  const response = await fetch("/register", {
    method: "POST",
    body: formData
  });

  if (response.ok) {
    usernameModal.style.display = "none";
    sensorModal.style.display = "block";
  } else {
    passwordError.textContent = "Something went wrong, please try again.";
    passwordError.style.display = "block";
  }
});
</script>

</body>
</html>
